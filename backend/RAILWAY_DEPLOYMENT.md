# Деплой FastAPI Backend на Railway

Это руководство поможет вам задеплоить бэкенд FastAPI приложения на Railway.

## Подготовка к деплою

### 1. Структура проекта
```
backend/
├── server.py          # Основной файл FastAPI приложения
├── requirements.txt   # Python зависимости
├── Procfile          # Конфигурация для Railway
├── railway.json      # Дополнительная конфигурация Railway
├── env.example       # Пример переменных окружения
└── RAILWAY_DEPLOYMENT.md # Это руководство
```

### 2. Переменные окружения

Вам нужно настроить следующие переменные окружения в Railway:

#### Обязательные переменные:
- `DATABASE_URL` - URL вашей PostgreSQL базы данных из Supabase
- `SECRET_KEY` - Секретный ключ для JWT токенов
- `ADMIN_LOGIN` - Логин администратора (по умолчанию: admin)
- `ADMIN_PASSWORD` - Пароль администратора (по умолнии: admin123)

#### Опциональные переменные:
- `PORT` - Порт приложения (Railway автоматически назначит)
- `ACCESS_TOKEN_EXPIRE_MINUTES` - Время жизни JWT токена (по умолчанию: 30)
- `DEFAULT_WEBHOOK_URL` - URL webhook для интеграций

### 3. Формат DATABASE_URL для Supabase
```
postgresql://postgres:[YOUR-PASSWORD]@[YOUR-PROJECT-REF].supabase.co:5432/postgres
```

## Инструкции по деплою

### Шаг 1: Подготовка репозитория
1. Убедитесь, что все файлы находятся в папке `backend/`
2. Закоммитьте изменения в git

### Шаг 2: Создание проекта на Railway
1. Зайдите на [Railway.app](https://railway.app)
2. Нажмите "New Project"
3. Выберите "Deploy from GitHub repo"
4. Выберите ваш репозиторий

### Шаг 3: Настройка деплоя
1. Railway автоматически определит, что это Python проект
2. Выберите папку `backend/` как корневую директорию
3. Railway автоматически установит зависимости из `requirements.txt`

### Шаг 4: Настройка переменных окружения
1. В настройках проекта перейдите в "Variables"
2. Добавьте все необходимые переменные:
   - `DATABASE_URL` - URL вашей Supabase базы
   - `SECRET_KEY` - Сгенерируйте случайный ключ
   - `ADMIN_LOGIN` - admin (или ваш логин)
   - `ADMIN_PASSWORD` - ваш пароль

### Шаг 5: Деплой
1. Railway автоматически запустит деплой
2. Дождитесь завершения сборки
3. Ваше приложение будет доступно по URL вида: `https://your-app-name.railway.app`

## Проверка работы

После деплоя проверьте:

1. **Health Check**: `GET https://your-app-name.railway.app/api/`
   - Должен вернуть: `{"message": "CargoSearch API - Платформа поиска контейнерных перевозок"}`

2. **Доступность портов**: `GET https://your-app-name.railway.app/api/ports`
   - Должен вернуть список портов

3. **Админ панель**: `POST https://your-app-name.railway.app/api/admin/login`
   - Проверьте авторизацию администратора

## API Endpoints

После деплоя ваше API будет доступно по следующим эндпоинтам:

### Основные эндпоинты:
- `GET /api/` - Health check
- `GET /api/ports` - Список портов
- `GET /api/container-types` - Типы контейнеров
- `POST /api/search` - Поиск маршрутов
- `POST /api/register` - Регистрация пользователей
- `POST /api/login` - Авторизация пользователей

### Админ эндпоинты:
- `POST /api/admin/login` - Авторизация администратора
- `GET /api/admin/webhook` - Настройки webhook
- `POST /api/admin/webhook` - Обновление webhook

## Устранение проблем

### Проблема с подключением к базе данных
- Проверьте правильность `DATABASE_URL`
- Убедитесь, что база данных Supabase доступна
- Проверьте настройки безопасности в Supabase

### Проблема с портами
- Railway автоматически назначает порт через переменную `PORT`
- Убедитесь, что приложение использует `os.environ.get("PORT", 8001)`

### Проблема с зависимостями
- Проверьте `requirements.txt`
- Убедитесь, что все зависимости совместимы

## Мониторинг

Railway предоставляет:
- Логи приложения в реальном времени
- Метрики использования
- Автоматические перезапуски при ошибках

## Обновление

Для обновления приложения:
1. Внесите изменения в код
2. Закоммитьте в git
3. Railway автоматически запустит новый деплой

## Поддержка

Если возникли проблемы:
1. Проверьте логи в Railway Dashboard
2. Убедитесь, что все переменные окружения настроены
3. Проверьте статус базы данных Supabase

